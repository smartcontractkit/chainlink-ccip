package commit_test

import (
	"encoding/base64"
	"encoding/json"
	"testing"

	"github.com/smartcontractkit/chainlink-ccip/commit"
	"github.com/stretchr/testify/require"
)

func TestUnmarshal(t *testing.T) {
	jsonB64 := "eyJtZXJrbGVPYnMiOnsibWVya2xlUm9vdHMiOm51bGwsIm9uUmFtcE1heFNlcU51bXMiOlt7ImNoYWluU2VsIjo1NTQ4NzE4NDI4MDE4NDEwNzQxLCJzZXFOdW0iOjF9XSwib2ZmUmFtcE5leHRTZXFOdW1zIjpbeyJjaGFpblNlbCI6NTU0ODcxODQyODAxODQxMDc0MSwic2VxTnVtIjoxfV0sInJtblJlbW90ZUNvbmZpZyI6eyJjb250cmFjdEFkZHJlc3MiOiIweCIsImNvbmZpZ0RpZ2VzdCI6IjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCIsInNpZ25lcnMiOm51bGwsIm1pblNpZ25lcnMiOjAsImNvbmZpZ1ZlcnNpb24iOjAsInJtblJlcG9ydFZlcnNpb24iOiIweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAifSwiZkNoYWluIjp7IjU1NDg3MTg0MjgwMTg0MTA3NDEiOjEsIjc4OTA2ODg2NjQ4NDM3MzA0NiI6MX19LCJ0b2tlbk9icyI6eyJmZWVkVG9rZW5QcmljZXMiOltdLCJmZWVRdW90ZXJUb2tlblVwZGF0ZXMiOnt9LCJmQ2hhaW4iOnsiNTU0ODcxODQyODAxODQxMDc0MSI6MSwiNzg5MDY4ODY2NDg0MzczMDQ2IjoxfSwidGltZXN0YW1wIjoiMjAyNC0xMC0xMFQxODoxMDo0NC4xMDg3NTRaIn0sImNoYWluRmVlT2JzIjp7ImZlZUNvbXBvbmVudHMiOnsiNTU0ODcxODQyODAxODQxMDc0MSI6eyJFeGVjdXRpb25GZWUiOjIwMDAwMDAwMDAwLCJEYXRhQXZhaWxhYmlsaXR5RmVlIjowfSwiNzg5MDY4ODY2NDg0MzczMDQ2Ijp7IkV4ZWN1dGlvbkZlZSI6MjAwMDAwMDAwMDAsIkRhdGFBdmFpbGFiaWxpdHlGZWUiOjB9LCI5MDk2MDY3NDY1NjE3NDIxMjMiOnsiRXhlY3V0aW9uRmVlIjoyMDAwMDAwMDAwMCwiRGF0YUF2YWlsYWJpbGl0eUZlZSI6MH19LCJuYXRpdmVUb2tlblByaWNlIjp7fSwiY2hhaW5GZWVVcGRhdGVzIjp7fSwiZkNoYWluIjp7IjU1NDg3MTg0MjgwMTg0MTA3NDEiOjEsIjc4OTA2ODg2NjQ4NDM3MzA0NiI6MX0sInRpbWVzdGFtcCI6IjIwMjQtMTAtMTBUMTg6MTA6NDQuMTA5MjE4WiJ9LCJkaXNjb3ZlcnlPYnMiOnsiRkNoYWluIjp7IjU1NDg3MTg0MjgwMTg0MTA3NDEiOjEsIjc4OTA2ODg2NjQ4NDM3MzA0NiI6MX0sIkFkZHJlc3NlcyI6eyJGZWVRdW90ZXIiOnsiNzg5MDY4ODY2NDg0MzczMDQ2IjoiNHVWZ1pWTG5icHFtdlhTV1ZPcFVYTjVnZ0IwPSJ9LCJOb25jZU1hbmFnZXIiOnsiNzg5MDY4ODY2NDg0MzczMDQ2IjoicXhOaXB1VWZDMTFxZGZaaFdtK0U0MGN2d2F3PSJ9LCJPblJhbXAiOnsiNTU0ODcxODQyODAxODQxMDc0MSI6IkFBQUFBQUFBQUFBQUFBQUFkNHRIUHJVRGpWRWc1aS80T2Q1SWVjSS81UVU9In0sIlJNTlJlbW90ZSI6eyI3ODkwNjg4NjY0ODQzNzMwNDYiOiJDT004MWNaMUlZUXYzSnNPcE4zMDFCODdHVHc9In19fSwiZkNoYWluIjp7IjU1NDg3MTg0MjgwMTg0MTA3NDEiOjEsIjc4OTA2ODg2NjQ4NDM3MzA0NiI6MX19"
	jsonBytes, err := base64.StdEncoding.DecodeString(jsonB64)
	require.NoError(t, err)

	t.Log("raw json:", string(jsonBytes))

	var obs commit.Observation
	err = json.Unmarshal(jsonBytes, &obs)
	require.NoError(t, err)
	t.Logf("obs: %+v", obs)

	obs2, err := commit.DecodeCommitPluginObservation(jsonBytes)
	require.NoError(t, err)
	require.Equal(t, obs, obs2)
	t.Logf("obs2: %+v", obs2)
}

func TestUnmarshal_AttributedObservation(t *testing.T) {
	jsonB64 := `eyJtZXJrbGVPYnMiOnsibWVya2xlUm9vdHMiOm51bGwsIm9uUmFtcE1heFNlcU51bXMiOm51bGwsIm9mZlJhbXBOZXh0U2VxTnVtcyI6bnVsbCwicm1uUmVtb3RlQ29uZmlnIjp7ImNvbnRyYWN0QWRkcmVzcyI6IjB4IiwiY29uZmlnRGlnZXN0IjoiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwIiwic2lnbmVycyI6bnVsbCwibWluU2lnbmVycyI6MCwiY29uZmlnVmVyc2lvbiI6MCwicm1uUmVwb3J0VmVyc2lvbiI6IjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCJ9LCJmQ2hhaW4iOm51bGx9LCJ0b2tlbk9icyI6eyJmZWVkVG9rZW5QcmljZXMiOm51bGwsImZlZVF1b3RlclRva2VuVXBkYXRlcyI6bnVsbCwiZkNoYWluIjpudWxsLCJ0aW1lc3RhbXAiOiIwMDAxLTAxLTAxVDAwOjAwOjAwWiJ9LCJjaGFpbkZlZU9icyI6eyJmZWVDb21wb25lbnRzIjpudWxsLCJuYXRpdmVUb2tlblByaWNlIjpudWxsLCJjaGFpbkZlZVVwZGF0ZXMiOm51bGwsImZDaGFpbiI6bnVsbCwidGltZXN0YW1wIjoiMDAwMS0wMS0wMVQwMDowMDowMFoifSwiZGlzY292ZXJ5T2JzIjp7IkZDaGFpbiI6eyI1NTQ4NzE4NDI4MDE4NDEwNzQxIjoxLCI3ODkwNjg4NjY0ODQzNzMwNDYiOjF9LCJBZGRyZXNzZXMiOnsiRmVlUXVvdGVyIjp7Ijc4OTA2ODg2NjQ4NDM3MzA0NiI6IjR1VmdaVkxuYnBxbXZYU1dWT3BVWE41Z2dCMD0ifSwiTm9uY2VNYW5hZ2VyIjp7Ijc4OTA2ODg2NjQ4NDM3MzA0NiI6InF4TmlwdVVmQzExcWRmWmhXbStFNDBjdndhdz0ifSwiT25SYW1wIjp7IjU1NDg3MTg0MjgwMTg0MTA3NDEiOiJBQUFBQUFBQUFBQUFBQUFBZDR0SFByVURqVkVnNWkvNE9kNUllY0kvNVFVPSJ9LCJSTU5SZW1vdGUiOnsiNzg5MDY4ODY2NDg0MzczMDQ2IjoiQ09NODFjWjFJWVF2M0pzT3BOMzAxQjg3R1R3PSJ9fX0sImZDaGFpbiI6bnVsbH0=`
	jsonBytes, err := base64.StdEncoding.DecodeString(jsonB64)
	require.NoError(t, err)

	t.Log("raw json:", string(jsonBytes))

	var obs commit.Observation
	err = json.Unmarshal(jsonBytes, &obs)
	require.NoError(t, err)
	t.Logf("obs: %+v", obs)
}
