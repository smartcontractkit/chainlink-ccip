---
in: |
  deployments:
    chainlink-don:
      helm:
        releaseName: ${DON_TYPE}
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/chainlink-cluster/type.base.yaml
        values:
          gatewayMode:
            enabled: true
            rdsCidr: 10.0.0.0/8
          fullnameOverride: ${DON_TYPE}
          nodeCount: {{ .Env.DON_NODE_COUNT }}
          bootNodeCount: {{ .Env.DON_BOOT_NODE_COUNT }}
          serviceAccount:
            enabled: false
            name: 'default'
          overrides:
          {{- if gt (conv.ToInt .Env.DON_BOOT_NODE_COUNT) 0 }}
          {{- range $i := seq 0 (math.Sub .Env.DON_BOOT_NODE_COUNT 1) }}
            - chainlinkNode:
                spec:
                  database:
                    config:
                      host: ${DON_TYPE}-db-bt-{{ $i }}
                  nodeName: ${DON_TYPE}-bt-{{ $i }}
              chainlink:
                v2Config:
                  99-config-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/config-override-bt-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
                v2Secret:
                  99-secrets-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/secrets-override-bt-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
          {{- end }}
          {{- end }}
          {{- if gt (conv.ToInt .Env.DON_NODE_COUNT) 0 }}
          {{- range $i := seq 0 (math.Sub .Env.DON_NODE_COUNT 1) }}
            - chainlinkNode:
                spec:
                  database:
                    config:
                      host: ${DON_TYPE}-db-{{ $i }}
                  nodeName: ${DON_TYPE}-{{ $i }}
              chainlink:
                v2Config:
                  99-config-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/config-override-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
                v2Secret:
                  99-secrets-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/secrets-override-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
          {{- end }}
          {{- end }}
    {{- if gt (conv.ToInt .Env.DON_GATEWAY_NODE_COUNT) 0 }}
    chainlink-don-gateway:
      helm:
        releaseName: ${DON_TYPE}-gateway
        chart:
          name: ${CHAINLINK_HELM_REGISTRY_URI}/chainlink-cluster
          version: "2.4.4"
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/chainlink-cluster/type.base.yaml
          - ${LOCAL_VALUES_DIR}/chainlink-cluster/type.gateway.yaml
        values:
          fullnameOverride: ${DON_TYPE}-gateway
          nodeCount: {{ $.Env.DON_GATEWAY_NODE_COUNT }}
          bootNodeCount: 0
          serviceAccount:
            enabled: false
            name: 'default'
          gatewayMode:
            enabled: true
            public: false
            rdsCidr: 10.0.0.0/8
            serviceType: NodePort
          networkPolicy:
            enabled: false
          overrides:
          {{- range $i := seq 0 (math.Sub $.Env.DON_GATEWAY_NODE_COUNT 1) }}
            - chainlinkNode:
                spec:
                  database:
                    config:
                      host: ${DON_TYPE}-gateway-db-{{ $i }}
          {{- end }}
    {{- end }}
    {{- if gt (conv.ToInt .Env.DON_BOOT_NODE_COUNT) 0 }}
    {{- range $i := seq 0 (math.Sub .Env.DON_BOOT_NODE_COUNT 1) }}
    chainlink-don-db-bt-{{ strings.ToLower (getenv "DON_TYPE") }}-{{ $i }}:
      updateImageTags: false
      namespace: ${DEVSPACE_NAMESPACE}
      helm:
        releaseName: ${DON_TYPE}-db-bt-{{ $i }}
        chart:
          name: oci://registry-1.docker.io/bitnamicharts/postgresql
          version: {{ $.Env.POSTGRES_CHART_VERSION }}
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/postgresql/type.dev.yaml
          {{- if ne $.Env.PROVIDER "kind" }}
          - ${LOCAL_VALUES_DIR}/postgresql/pvc.dev.yaml
          {{- end }}
          {{- if eq $.Env.PROVIDER "aws" }}
          - ${LOCAL_VALUES_DIR}/postgresql/env.crib-staging.yaml
          {{- end }}
        values:
          fullnameOverride: ${DON_TYPE}-db-bt-{{ $i }}
    {{- end }}
    {{- end }}
    {{- if gt (conv.ToInt .Env.DON_NODE_COUNT) 0 }}
    {{- range $i := seq 0 (math.Sub .Env.DON_NODE_COUNT 1) }}
    chainlink-don-db-{{ strings.ToLower (getenv "DON_TYPE") }}-{{ $i }}:
      updateImageTags: false
      namespace: ${DEVSPACE_NAMESPACE}
      helm:
        releaseName: ${DON_TYPE}-db-{{ $i }}
        chart:
          name: oci://registry-1.docker.io/bitnamicharts/postgresql
          version: {{ $.Env.POSTGRES_CHART_VERSION }}
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/postgresql/type.dev.yaml
          {{- if ne $.Env.PROVIDER "kind" }}
          - ${LOCAL_VALUES_DIR}/postgresql/pvc.dev.yaml
          {{- end }}
          {{- if eq $.Env.PROVIDER "aws" }}
          - ${LOCAL_VALUES_DIR}/postgresql/env.crib-staging.yaml
          {{- end }}
        values:
          fullnameOverride: ${DON_TYPE}-db-{{ $i }}
    {{- end }}
    {{- end }}
    {{- if gt (conv.ToInt .Env.DON_GATEWAY_NODE_COUNT) 0 }}
    {{- range $i := seq 0 (math.Sub .Env.DON_GATEWAY_NODE_COUNT 1) }}
    chainlink-don-gateway-db-{{ $i }}:
      updateImageTags: false
      namespace: ${DEVSPACE_NAMESPACE}
      helm:
        releaseName: ${DON_TYPE}-gateway-db-{{ $i }}
        chart:
          name: oci://registry-1.docker.io/bitnamicharts/postgresql
          version: {{ $.Env.POSTGRES_CHART_VERSION }}
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/postgresql/type.dev.yaml
          {{- if ne $.Env.PROVIDER "kind" }}
          - ${LOCAL_VALUES_DIR}/postgresql/pvc.dev.yaml
          {{- end }}
          {{- if and (eq $.Env.PROVIDER "aws") (eq $.Env.CRIB_EKS_CLUSTER_NAME "main-stage-cluster") }}
          - ${LOCAL_VALUES_DIR}/postgresql/env.crib-staging.yaml
          {{- else if and (eq $.Env.PROVIDER "aws") (eq $.Env.ENV "sandbox") }}
          - ${LOCAL_VALUES_DIR}/postgresql/env.crib-sandbox.yaml
          {{- end }}
        values:
          fullnameOverride: ${DON_TYPE}-gateway-db-{{ $i }}
    {{- end }}
    {{- end }}
  {{- if gt (conv.ToInt .Env.DON_GATEWAY_NODE_COUNT) 0 }}
  hooks:
    # This hook will ensure that every time the deployment
    # chainlink-don-gateway is deployed that DevSpace will wait until
    # all pods and containers that match the labelSelector
    # app.kubernetes.io/name: chainlink-don-gateway are running
    # https://www.devspace.sh/docs/configuration/hooks/#wait-for-a-pod-to-be-running
    - wait:
        running: true
        timeout: 300
        # This can be needed for init containers
        # that terminate instead of become running.
        terminatedWithCode: 0
      container:
        labelSelector:
          "app.kubernetes.io/name": "chainlink-don-gateway"
      name: "wait-for-chainlink-don-gateway-pods"
      events: ["after:deploy:chainlink-don-gateway"]
    {{- end }}
