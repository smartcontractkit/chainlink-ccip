---
in: |
  deployments:
    chainlink-don:
      helm:
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/chainlink-cluster/type.base.yaml
        values:
          gatewayMode:
            enabled: true
            rdsCidr: 10.0.0.0/8
          fullnameOverride: ${DON_TYPE}
          nodeCount: {{ .Env.DON_NODE_COUNT }}
          bootNodeCount: {{ .Env.DON_BOOT_NODE_COUNT }}
          serviceAccount:
            enabled: false
            name: 'default'
          overrides:
          {{- if gt (conv.ToInt .Env.DON_BOOT_NODE_COUNT) 0 }}
          {{- range $i := seq 0 (math.Sub .Env.DON_BOOT_NODE_COUNT 1) }}
            - chainlinkNode:
                spec:
                  database:
                    config:
                      host: ${DON_TYPE}-db-bt-{{ $i }}
                  nodeName: ${DON_TYPE}-bt-{{ $i }}
              chainlink:
                v2Config:
                  99-config-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/config-override-bt-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
                v2Secret:
                  99-secrets-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/secrets-override-bt-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
          {{- end }}
          {{- end }}
          {{- if gt (conv.ToInt .Env.DON_NODE_COUNT) 0 }}
          {{- range $i := seq 0 (math.Sub .Env.DON_NODE_COUNT 1) }}
            - chainlinkNode:
                spec:
                  database:
                    config:
                      host: ${DON_TYPE}-db-{{ $i }}
                  nodeName: ${DON_TYPE}-{{ $i }}
              chainlink:
                v2Config:
                  99-config-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/config-override-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
                v2Secret:
                  99-secrets-override.toml: |
                    {{- printf "\n" }}
                    {{- file.Read (printf "%s/%s/secrets-override-%d.toml" (getenv "CRE_CONFIG_DIR") (getenv "DON_TYPE") $i) | strings.Indent 18 }}
          {{- end }}
          {{- end }}
    {{- if gt (conv.ToInt .Env.DON_BOOT_NODE_COUNT) 0 }}
    {{- range $i := seq 0 (math.Sub .Env.DON_BOOT_NODE_COUNT 1) }}
    chainlink-don-db-bt-{{ strings.ToLower (getenv "DON_TYPE") }}-{{ $i }}:
      updateImageTags: false
      namespace: ${DEVSPACE_NAMESPACE}
      helm:
        chart:
          name: oci://registry-1.docker.io/bitnamicharts/postgresql
          version: {{ $.Env.POSTGRES_CHART_VERSION }}
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/postgresql/type.dev.yaml
          {{- if ne $.Env.PROVIDER "kind" }}
          - ${LOCAL_VALUES_DIR}/postgresql/pvc.dev.yaml
          {{- end }}
          {{- if eq $.Env.PROVIDER "aws" }}
          - ${LOCAL_VALUES_DIR}/postgresql/env.crib-staging.yaml
          {{- end }}
        values:
          fullnameOverride: ${DON_TYPE}-db-bt-{{ $i }}
    {{- end }}
    {{- end }}
    {{- if gt (conv.ToInt .Env.DON_NODE_COUNT) 0 }}
    {{- range $i := seq 0 (math.Sub .Env.DON_NODE_COUNT 1) }}
    chainlink-don-db-{{ strings.ToLower (getenv "DON_TYPE") }}-{{ $i }}:
      updateImageTags: false
      namespace: ${DEVSPACE_NAMESPACE}
      helm:
        chart:
          name: oci://registry-1.docker.io/bitnamicharts/postgresql
          version: {{ $.Env.POSTGRES_CHART_VERSION }}
        valuesFiles:
          - ${LOCAL_VALUES_DIR}/postgresql/type.dev.yaml
          {{- if ne $.Env.PROVIDER "kind" }}
          - ${LOCAL_VALUES_DIR}/postgresql/pvc.dev.yaml
          {{- end }}
          {{- if eq $.Env.PROVIDER "aws" }}
          - ${LOCAL_VALUES_DIR}/postgresql/env.crib-staging.yaml
          {{- end }}
        values:
          fullnameOverride: ${DON_TYPE}-db-{{ $i }}
    {{- end }}
    {{- end }}
