---
version: v2beta1
name: chainlink-daas-operator-resources

require:
  devspace: ">= 6.0"

vars:
  # default
  DEVSPACE_ENV_FILE:
    source: env
    default: .env
  # switches / activation
  ENV: # options=[local|stage|prod]
    source: env
    default: prod
  PROVIDER: # options=[kind|aws]
    source: all
    default: aws
  REGISTRY: # options=[localhost|aws]
    source: env
    default: prod
  CHARTS: # options=[local|aws]
    source: env
    default: aws
  ## local directories
  CRIB_DIR: $(git rev-parse --show-toplevel 2>/dev/null)
  CHARTS_DIR:
    source: env
    default: "${CRIB_DIR}/../infra-charts"
  # specific
  CHAINLINK_HELM_REGISTRY_URI:
    source: env
    default: "oci://804282218731.dkr.ecr.us-west-2.amazonaws.com/infra-charts"
  HOST_NAME:
    source: env
    default: main.stage.cldev.sh
  AWS_ACM_CERT_ARN:
    source: env
    default: ""

pullSecrets:
  regcred-prod:
    registry: 804282218731.dkr.ecr.us-west-2.amazonaws.com
    secret: regcred-prod
  regcred-sdlc:
    registry: 795953128386.dkr.ecr.us-west-2.amazonaws.com
    secret: regcred-sdlc

pipelines:
  deploy:
    run: |-
      create_deployments daas-operator-resources
  purge:
    run: |-
      purge_deployments daas-operator-resources

deployments:
  daas-operator-resources:
    namespace: ${DEVSPACE_NAMESPACE}
    helm:
      chart:
        name: ${CHAINLINK_HELM_REGISTRY_URI}/daas-operator-resources
        version: 0.0.3
      values:
        dapi:
          enabled: true
          image: {}
          imagePullSecrets: []
          service:
            type: ClusterIP
          ingress:
            enabled: false
        extraManifests: []
      upgradeArgs: ["--no-hooks"]
      templateArgs: ["--no-hooks"]

profiles:
  ###########################
  ## chart options
  ###########################

  - name: use-local-charts
    activation:
      - vars:
          CHARTS: local
    merge:
      deployments:
        daas-operator-resources:
          helm:
            chart:
              name: daas-operator-resources
              path: ${CHARTS_DIR}/daas-operator-resources
              version: null

  ###########################
  ## image registry options
  ###########################

  - name: use-aws-registry
    activation: # match all
      - vars:
          PROVIDER: aws
          REGISTRY: aws
    patches:
      - op: replace
        path: deployments.daas-operator-resources.helm.values.dapi.image
        value:
          repository: 804282218731.dkr.ecr.us-west-2.amazonaws.com/daas
          pullPolicy: Always
          tag: 0.0.8

  - name: use-aws-registry-on-local
    activation: # match all
      - vars:
          ENV: local
          REGISTRY: aws
    patches:
      - op: replace
        path: deployments.daas-operator-resources.helm.values.dapi.imagePullSecrets
        value:
          - name: regcred-prod
      - op: replace
        path: deployments.daas-operator-resources.helm.values.dapi.image
        value:
          repository: 804282218731.dkr.ecr.us-west-2.amazonaws.com/daas
          pullPolicy: Always
          tag: 0.0.8

  - name: use-localhost-registry
    activation: # match all
      - vars:
          ENV: local
          REGISTRY: localhost
    patches:
      - op: replace
        path: deployments.daas-operator-resources.helm.values.dapi.image
        value:
          repository: localhost:5001/daas
          pullPolicy: Always
          tag: local

  ###########################
  ## ingress options
  ###########################

  - name: ingress-local
    activation:
      - vars:
          ENV: local
    patches:
      - op: replace
        path: deployments.daas-operator-resources.helm.values.dapi.ingress
        value:
          enabled: true
          annotations:
            nginx.ingress.kubernetes.io/backend-protocol: HTTP
            nginx.ingress.kubernetes.io/use-regex: "true"
          ingressClassName: nginx
          host: dapi.${HOST_NAME}
          path: /
          pathType: Prefix
