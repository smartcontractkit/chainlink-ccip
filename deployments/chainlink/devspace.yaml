version: v2beta1
name: chainlink

vars:
  SCRIPTS_DIR:
    source: env
    default: "../../scripts"
  DEPENDENCIES_DIR:
    source: env
    default: "../../dependencies"
  IMPORTS_DIR:
    source: env
    default: "../../imports"
  # "The provider being used to deploy CRIB"
  PROVIDER:
    source: all
    default: "aws"
  CHAINLINK_CODE_DIR:
    source: env
    default: "../../.."
  CHAINLINK_HELM_REGISTRY_URI:
    source: env
    default: "oci://804282218731.dkr.ecr.us-west-2.amazonaws.com/infra-charts"


pipelines:
  core:
    run: |-
      run_dependency_pipelines crib-chainlink-cluster

  core-kind:
    run: |-
      run_pipelines kind
      run_pipelines core

  ccip-kind:
    run: |-
      run_pipelines kind
      run_pipelines ccip

  ccip:
    run: |-
      run_dependency_pipelines crib-chainlink-cluster
      run_dependency_pipelines crib-ccip-scripts

  kind:
    run: |-
      ensure_pull_secrets --all
      run_dependency_pipelines loki
      run_dependency_pipelines promtail
      run_dependency_pipelines grafana

  purge:
    run: |-
      kubectl delete ns ${DEVSPACE_NAMESPACE}

profiles:
  - name: core-kind
    parents:
    - profile: core
    - profile: kind
    patches:
    - op: replace
      path: dependencies.crib-chainlink-cluster.profiles
      value:
        - core
        - kind
    - op: add
      path: dependencies.crib-chainlink-cluster.pipeline
      value: kind
  - name: ccip-kind
    parents:
      - profile: ccip
      - profile: kind
    patches:
      - op: replace
        path: dependencies.crib-chainlink-cluster.profiles
        value:
          - ccip
          - kind
      - op: add
        path: dependencies.crib-chainlink-cluster.pipeline
        value: kind
      - op: add
        path: dependencies.crib-ccip-scripts.profiles
        value:
          - kind
      - op: add
        path: dependencies.crib-ccip-scripts.pipeline
        value: kind
  - name: core
    patches:
    - op: add
      path: vars
      value:
        DEVSPACE_IMAGE_TAG:
          source: env
          default: "323150190480.dkr.ecr.us-west-2.amazonaws.com/chainlink-devspace"
        CHAINLINK_REPO_DIR:
          source: env
          default: "${CHAINLINK_CODE_DIR}/chainlink"
    - op: add
      path: dependencies
      value:
        crib-chainlink-cluster:
          path: ${DEPENDENCIES_DIR}/crib-chainlink-cluster
          overwriteVars: true
          namespace: ${DEVSPACE_NAMESPACE}
          profiles:
            - core
  - name: ccip
    patches:
    - op: add
      path: vars
      value:
        DEVSPACE_IMAGE_TAG:
          source: env
          default: "323150190480.dkr.ecr.us-west-2.amazonaws.com/chainlink-ccip-devspace"
        CHAINLINK_REPO_DIR:
          source: env
          default: "${CHAINLINK_CODE_DIR}/ccip"
        # Env Vars Required for ccip-scripts based contracts and jobs deployment
        # Image URI required for deploying CCIP Contracts and Jobs
        DEVSPACE_CCIP_SCRIPTS_IMAGE:
          source: env
          default: "804282218731.dkr.ecr.us-west-2.amazonaws.com/ccip-scripts:latest"
        # AWS Role ARN required for uploading deploy job output to s3
        DEVSPACE_CCIP_SCRIPTS_OIDC_ROLE_ARN:
          source: env
          default: "arn:aws:iam::323150190480:role/ccip-scripts-deployer-upload"
        # AWS S3 bucket name required for uploading deploy job output to s3
        DEVSPACE_CCIP_SCRIPTS_OUTPUT_BUCKET_NAME:
          source: env
          default: "cl-stage-ccip-scripts-deploy-output"
    - op: add
      path: dependencies
      value:
        crib-chainlink-cluster:
          path: ${DEPENDENCIES_DIR}/crib-chainlink-cluster
          overwriteVars: true
          namespace: ${DEVSPACE_NAMESPACE}
          profiles:
            - ccip
        crib-ccip-scripts:
          path: ${DEPENDENCIES_DIR}/crib-ccip-scripts
          overwriteVars: true
          namespace: ${DEVSPACE_NAMESPACE}
  - name: kind
    patches:
    - op: add
      path: dependencies
      value:
        grafana:
          path: ${DEPENDENCIES_DIR}/grafana
          namespace: ${DEVSPACE_NAMESPACE}
          overwriteVars: true
          profiles:
            - kind
        loki:
          path: ${DEPENDENCIES_DIR}/loki
          namespace: ${DEVSPACE_NAMESPACE}
          overwriteVars: true
          profiles:
            - kind
        promtail:
          path: ${DEPENDENCIES_DIR}/promtail
          namespace: ${DEVSPACE_NAMESPACE}
          overwriteVars: true
          profiles:
            - default

commands:
  ccip:
    command: devspace run-pipeline ccip -p ccip
    description: Run the CCIP pipeline.
    appendArgs: true
  core:
    command: devspace run-pipeline core -p core
    description: Run the Core pipeline.
    appendArgs: true
  core-kind:
    command: devspace run-pipeline core-kind -p core-kind
    description: Run the Core pipeline for Kind.
    appendArgs: true
  ccip-kind:
    command: devspace run-pipeline ccip-kind -p ccip-kind
    description: Run the Core pipeline for Kind.
    appendArgs: true
