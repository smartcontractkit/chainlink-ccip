version: v2beta1

pipelines:
  beholder:
    run: |-
      create_deployments configs
      create_deployments beholder-prometheus

      create_deployments crib-beholder-infra
      create_deployments beholder-test-client

deployments:
  configs:
    kubectl:
      manifests:
      - ${COMPONENTS_DIR}/beholder/configmaps/prometheus.yaml

  beholder-test-client:
    updateImageTags: false
    namespace: ${DEVSPACE_NAMESPACE}
    helm:
      releaseName: beholder-test-client
      displayOutput: true
      chart:
        name: ${CHAINLINK_HELM_REGISTRY_URI}/beholder-test-client
        version: "0.0.3"
      values:
        podSecurityContext:
          fsGroup: 999

        beholder-test-client:
          args:
            - -otel-exporter-grpc-enpoint
            - crib-beholder-infra-otel-collector-agent:4317

  beholder-prometheus:
    namespace: ${DEVSPACE_NAMESPACE}
    helm:
      chart:
        name: component-chart
        repo: https://charts.devspace.sh
      values:
        containers:
          - image: prom/prometheus
            args:
            - "--config.file=/etc/prometheus/config/prometheus.yml"
            volumeMounts:
            - containerPath: /etc/prometheus/config
              volume:
                name: config-volume
        podSecurityContext:
          fsGroup: 65534
        securityContext:
          runAsUser: 65534
          runAsGroup: 65534
          fsGroup: 65534
        service:
          name: beholder-prometheus
          selector:
            app: beholder-prometheus
          ports:
          - port: 9090
        volumes:
          - name: config-volume
            configMap:
              name: prometheus-config
  crib-beholder-infra:
    updateImageTags: false
    namespace: ${DEVSPACE_NAMESPACE}
    helm:
      releaseName: crib-beholder-infra
      displayOutput: true
      chart:
        name: ${CHAINLINK_HELM_REGISTRY_URI}/crib-beholder-infra
        version: "0.0.4"
      values:
        podSecurityContext:
          fsGroup: 999

        otel-collector-agent:
          config:
            exporters:
              otlp:
                endpoint: crib-beholder-infra-otel-collector-gateway:4317

        otel-collector-gateway:
          config:
            exporters:
              kafka:
                brokers:
                  - crib-beholder-infra-kafka:9092


profiles:
  - name: local-charts
    merge:
      deployments:
        beholder-test-client:
          helm:
            chart:
              name: beholder-test-client
              path: ${CHAINLINK_CODE_DIR}/infra-charts/beholder-test-client
              version: null
        crib-beholder-infra:
          helm:
            chart:
              name: crib-beholder-infra
              path: ${CHAINLINK_CODE_DIR}/infra-charts/crib-beholder-infra
              version: null
