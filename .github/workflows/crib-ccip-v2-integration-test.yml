name: CRIB CCIP-v2 Integration Tests
# This is a WIP workflow for e2e testing ccip-v2 flow
on:
  pull_request:
    paths:
      - ".github/workflows/crib-ccip-v2-integration-test.yml"
      - "dependencies/donut/**"
      - "dependencies/job-distributor/**"
      - "dependencies/geth-v2/**"
      - "dependencies/solana-validator/**"
      - "dependencies/rmn-v2/**"
      - "dependencies/ccip-v2-scripts/**"
      - "dependencies/postgres/**"
      # Exclude doc updates
      - "!**/*.md" # Exclude doc updates
      # Exclude .gitignore
      - "!.gitignore"
      # Exclude changesets version bumps
      - "!package.json"
      # Exclude CODEOWNERS
      - "CODEOWNERS"
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  workflow_dispatch:
    inputs:
      debug:
        description: |
          Enables debug mode to disable CRIB env teardown
        default: "false"
        required: false
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: read
      actions: read
      pull-requests: read
    steps:
      - name: Prevent running on draft or changesets PRs
        id: check-prereqs-for-running
        run: |
          should_run=true
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
              should_run=false
            elif [ "${{ github.event.pull_request.user.login }}" == "app-token-issuer-infra-releng[bot]" ] && [[ "${{ github.event.pull_request.title }}" == "Version Packages" ]]; then
              should_run=false
            fi
          fi
          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"

      - uses: cachix/install-nix-action@ba0dd844c9180cbf77aa72a116d6fbc515d0e87b # v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Deploy and validate CRIB Environment for CCIP v2
        if: steps.check-prereqs-for-running.outputs.should_run == 'true'
        uses: smartcontractkit/.github/actions/crib-deploy-environment@4fbc065ecab064ed483bd7a9a2fa6f05c8b65ef2 # crib-deploy-environment@8.5.3
        id: deploy
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-role-arn: ${{ secrets.AWS_OIDC_CRIB_ROLE_ARN_STAGE }}
          aws-ecr-private-registry: ${{ secrets.AWS_ACCOUNT_ID_PROD }}
          ingress-base-domain: ${{ secrets.INGRESS_BASE_DOMAIN_STAGE }}
          k8s-cluster-name: ${{ secrets.AWS_K8S_CLUSTER_NAME_STAGE }}
          command: "ccip-v2-infra"
          # crib-alert-slack-webhook: ${{ secrets.CRIB_ALERT_SLACK_WEBHOOK }}
          product-image: ${{ secrets.AWS_ACCOUNT_ID_SDLC }}.dkr.ecr.us-west-2.amazonaws.com/ccip
          product-image-tag: develop
          product-dir: 'ccip-v2'
          chainlink-team: releng
          chainlink-product: crib
          crib-repo-ref: ${{ github.ref }}
          main-dns-zone: ${{ secrets.MAIN_DNS_ZONE_STAGE_PUBLIC }}
          websockets-services: "gap-${DEVSPACE_NAMESPACE}-geth-1337-ws,gap-${DEVSPACE_NAMESPACE}-geth-2337-ws"

      - name: Destroy CRIB Environment
        id: destroy
        if: always() && steps.deploy.outputs.devspace-namespace != '' && inputs.debug != 'true' && steps.check-prereqs-for-running.outputs.should_run == 'true'
        uses: smartcontractkit/.github/actions/crib-purge-environment@142671bc21953c8cc3edbd21848c50b5ec201c2a # crib-purge-environment@0.3.0
        with:
          namespace: ${{ steps.deploy.outputs.devspace-namespace }}
